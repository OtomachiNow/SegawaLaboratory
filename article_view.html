<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>瀬川研究室</title>
    <!-- MathJax -->
    <script>
        window.MathJax = {
            tex: { inlineMath: [['$', '$'], ['\(', '\)']], displayMath: [['$$', '$$'], ['\[', '\]']] },
            options: { skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'] }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <!-- Highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/vs2015.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        body { margin: 0; background-color: #f4f4f4; font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; line-height: 1.7; color: #333; }
        .width-constraint { width: 92%; max-width: 850px; margin: 0 auto; box-sizing: border-box; }
        .header { text-align: center; background-color: rgba(0, 255, 255, 0.6); padding: 15px; margin-top: 10px; border-radius: 5px; }
        .header h1 { margin: 0; font-size: 1.8em; color: #333; }
        .header h1 a { text-decoration: none; color: inherit; }
        
        .main-container { background-color: #fff; margin: 20px auto; padding: 30px 40px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-height: 800px; }
        
        #article-title { font-size: 1.8em; margin-bottom: 5px; color: #333; border-bottom: 3px solid #00bcd4; padding-bottom: 10px; }
        #article-date { font-size: 0.85em; color: #999; margin-bottom: 30px; display: block; text-align: right; }

        .dialogue-row { display: flex; align-items: flex-start; margin-bottom: 20px; width: 100%; }
        .dialogue-row.left { flex-direction: row; }
        .dialogue-row.right { flex-direction: row-reverse; }

        .icon { width: 50px; height: 50px; border-radius: 50%; background-color: #ddd; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #333; font-size: 1.1em; border: 2px solid #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); background-size: cover; background-position: center; }
        
        .bubble { max-width: 75%; padding: 12px 18px; border-radius: 12px; position: relative; font-size: 0.95em; box-shadow: 0 1px 3px rgba(0,0,0,0.05); white-space: pre-wrap; word-break: break-word; }
        .left .bubble { margin-left: 15px; background-color: #f0f0f0; border-top-left-radius: 2px; }
        .right .bubble { margin-right: 15px; background-color: #e1f5fe; border-top-right-radius: 2px; }

        .section-heading { border-left: 5px solid #00bcd4; padding-left: 15px; margin: 40px 0 20px 0; font-size: 1.5em; font-weight: bold; color: #333; border-bottom: none; }
        .article-image { text-align: center; margin: 25px 0; }
        .article-image img { max-width: 90%; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .article-image figcaption { font-size: 0.8em; color: #777; margin-top: 8px; }

        pre { background-color: #f8f8f8; padding: 15px; border-radius: 4px; overflow-x: auto; color: #333; font-size: 0.9em; margin: 20px 0; border: none; }
        code { font-family: Consolas, "Courier New", monospace; }

        .article-box { margin: 25px auto; border-radius: 6px; overflow: hidden; border: 1px solid #ddd; font-size: 0.95em; max-width: 90%; }
        .box-title { padding: 8px 15px; font-weight: bold; background-color: #f1f1f1; border-bottom: 1px solid #ddd; font-size: 0.9em; }
        .box-body { padding: 15px 20px; background-color: #fff; }
        .box-def { border-color: #81c784; } .box-def .box-title { background-color: #e8f5e9; color: #2e7d32; }
        .box-thm { border-color: #64b5f6; } .box-thm .box-title { background-color: #e3f2fd; color: #1565c0; }
        .box-proof { border-color: #bdbdbd; } .box-proof .box-title { background-color: #f5f5f5; color: #616161; }
        .box-summary { border-color: #2196f3; } .box-summary .box-title { background-color: #2196f3; color: #fff; text-align: center; }
        .box-hw { border-color: #ff9800; } .box-hw .box-title { background-color: #ff9800; color: #fff; }

        .article-math { margin: 1.5em auto; text-align: center; }
        .box-summary { border-color: #2196f3; } .box-summary .box-title { background-color: #2196f3; color: #fff; text-align: center; }
        .box-hw { border-color: #ff9800; } .box-hw .box-title { background-color: #ff9800; color: #fff; }

        .article-math { margin: 1.5em auto; text-align: center; }

        /* 小説モード (なろう風) */
        .novel-mode {
            font-family: "Yu Mincho", "游明朝", serif;
            line-height: 1.6;
            font-size: 95%;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #fff;
            text-align: left;
        }
        .novel-mode .dialogue-row, .novel-mode .narrative-text {
            display: block;
            margin-bottom: 0;
            text-indent: 0;
        }
        .novel-mode .icon, .novel-mode .speaker-name { display: none !important; }
        .novel-mode .bubble {
            background-color: transparent !important;
            box-shadow: none;
            padding: 0;
            margin: 0;
            max-width: 100%;
            border-radius: 0;
            font-size: inherit;
            line-height: inherit;
        }
        .novel-mode .novel-text {
            margin-bottom: 0;
            text-indent: 0;
            min-height: 1em; /* 空行を維持 */
        }

        /* 前後ナビゲーション */
        .article-nav { display: flex; justify-content: space-between; margin: 20px 0; padding: 10px; background-color: #f9f9f9; border-radius: 5px; font-size: 0.9em; }
        .article-nav a { text-decoration: none; color: #00bcd4; font-weight: bold; }
        .article-nav a:hover { text-decoration: underline; }
        .nav-prev::before { content: "« "; }
        .nav-next::after { content: " »"; }

        .truth-table { margin: 20px auto; border-collapse: collapse; font-size: 0.95em; }
        .truth-table th, .truth-table td { border: 1px solid #ccc; padding: 8px 15px; text-align: center; }
        .truth-table th { background-color: #f5f5f5; font-weight: bold; border-bottom: 2px solid #aaa; }

        .foot { padding: 20px 0; text-align: center; background-color: burlywood; margin-top: 30px; margin-bottom: 20px; border-radius: 5px; font-size: 0.9em; }
    </style>
</head>
<body>

<div class="header width-constraint">
    <h1><a href="index.html">瀬川研究室</a></h1>
    <p class="subtitle">Segawa Laboratory!</p>
</div>

<div class="main-container width-constraint">
    <h1 id="article-title">読み込み中...</h1>
    <span id="article-date"></span>
    <div id="article-content"></div>
</div>

<footer class="foot width-constraint">
    &copy; 瀬川研究室
</footer>

<script>
    async function loadArticle() {
        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('p');

        if (!articleId) {
            document.getElementById('article-title').textContent = '記事が指定されていません。';
            return;
        }

        try {
            const configRes = await fetch('./config.json');
            const config = await configRes.json();
            const speakers = config.speakers || {};
            
            document.title = config.site_title || "記事";
            const siteTitleLink = document.querySelector(".header h1 a");
            if(siteTitleLink) siteTitleLink.textContent = config.site_title || "瀬川研究室";
            const subtitle = document.querySelector(".header .subtitle");
            if(subtitle) subtitle.textContent = config.site_subtitle || "Segawa Laboratory";

            const response = await fetch(`./posts/${articleId}.json`);
            if (!response.ok) throw new Error("記事データが見つかりません。");
            const article = await response.json();

            document.getElementById('article-title').textContent = article.title;
            document.getElementById('article-date').textContent = article.date;

            const contentArea = document.getElementById('article-content');
            contentArea.innerHTML = ''; 
            
            // 小説モード判定
            const isNovel = article.type === 'novel';
            if (isNovel) {
                contentArea.classList.add('novel-mode');
            } else {
                contentArea.classList.remove('novel-mode');
            }

            article.data.forEach(item => {
                if (item.type === 'dialogue') {
                    if (isNovel) {
                        // 小説モード: 装飾なしで中身だけを表示（ユーザーが自分で鍵カッコを書く想定）
                        const p = document.createElement('p');
                        p.className = 'novel-text';
                        p.innerHTML = item.content;
                        contentArea.appendChild(p);
                    } else {
                        // 通常モード: 吹き出し
                        const row = document.createElement('div');
                        row.className = 'dialogue-row';
                        const side = item.side || 'left';
                        row.classList.add(side);
    
                        const speakerKey = item.speaker.trim();
                        const profile = speakers[speakerKey] || { color: '#f0f0f0', icon: '' };
                        
                        const icon = document.createElement('div');
                        icon.className = 'icon';
                        if (profile.icon) {
                            icon.style.backgroundImage = `url(${profile.icon})`;
                            icon.textContent = '';
                        } else {
                            icon.textContent = speakerKey.charAt(0);
                        }
                        icon.style.backgroundColor = profile.color;
    
                    const bubble = document.createElement('div');
                    bubble.className = 'bubble';
                    bubble.innerHTML = item.content;
                    // 話者の設定色を適用（左右どちらでも）
                    if (profile.color) {
                        bubble.style.backgroundColor = profile.color;
                    }

                    row.appendChild(icon);
                        row.appendChild(bubble);
                        contentArea.appendChild(row);
                    }
                
                } else if (item.type === 'heading') {
                    const heading = document.createElement('h2');
                    heading.className = 'section-heading';
                    heading.textContent = item.content;
                    contentArea.appendChild(heading);

                } else if (item.type === 'text') {
                    const p = document.createElement('p');
                    p.className = isNovel ? 'novel-text' : 'narrative-text';
                    p.innerHTML = item.content;
                    contentArea.appendChild(p);

                } else if (item.type === 'math') {
                    const div = document.createElement('div');
                    div.className = 'article-math';
                    div.innerHTML = item.content;
                    contentArea.appendChild(div);

                } else if (item.type === 'code') {
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    if (item.language) code.className = `language-${item.language}`;
                    code.textContent = item.content;
                    pre.appendChild(code);
                    contentArea.appendChild(pre);

                } else if (item.type === 'box') {
                    const box = document.createElement('div');
                    box.className = 'article-box';
                    const t = item.title || "";
                    if (t.includes("定義")) box.classList.add("box-def");
                    else if (t.includes("定理")) box.classList.add("box-thm");
                    else if (t.includes("証明")) box.classList.add("box-proof");
                    else if (t.includes("まとめ")) box.classList.add("box-summary");
                    else if (t.includes("宿題")) box.classList.add("box-hw");

                    if (item.title) {
                        const title = document.createElement('div');
                        title.className = 'box-title';
                        title.textContent = item.title;
                        box.appendChild(title);
                    }
                    const body = document.createElement('div');
                    body.className = 'box-body';
                    body.innerHTML = item.content;
                    box.appendChild(body);
                    contentArea.appendChild(box);

                } else if (item.type === 'truth') {
                    const table = document.createElement('table');
                    table.className = 'truth-table';
                    item.rows.forEach((rowItems, index) => {
                        const tr = document.createElement('tr');
                        rowItems.forEach(cellText => {
                            const cell = document.createElement(index === 0 ? 'th' : 'td');
                            cell.innerHTML = cellText; // 数式対応のためinnerHTML
                            tr.appendChild(cell);
                        });
                        table.appendChild(tr);
                    });
                    contentArea.appendChild(table);
                }
            });

            // 前後ナビゲーションの生成
            try {
                const tocRes = await fetch('./posts/toc.json');
                if (tocRes.ok) {
                    const toc = await tocRes.json();
                    // articleId は "logic/01" のような形式
                    const [cat, id] = articleId.split('/');
                    const list = toc[cat];
                    if (list) {
                        const idx = list.findIndex(item => item.id === articleId);
                        if (idx !== -1) {
                            const prev = list[idx - 1];
                            const next = list[idx + 1];
                            
                            const createNav = () => {
                                const nav = document.createElement('div');
                                nav.className = 'article-nav';
                                
                                const prevLink = document.createElement('div');
                                prevLink.className = 'nav-prev';
                                if (prev) {
                                    prevLink.innerHTML = `<a href="article_view.html?p=${prev.id}">${prev.title}</a>`;
                                } else {
                                    prevLink.textContent = " ";
                                }
                                
                                const nextLink = document.createElement('div');
                                nextLink.className = 'nav-next';
                                if (next) {
                                    nextLink.innerHTML = `<a href="article_view.html?p=${next.id}">${next.title}</a>`;
                                } else {
                                    nextLink.textContent = " ";
                                }
                                
                                nav.appendChild(prevLink);
                                nav.appendChild(nextLink);
                                return nav;
                            };

                            // 上部ナビゲーション（タイトルの下）
                            const titleArea = document.querySelector('.article-title') || document.getElementById('article-date');
                            if (titleArea && titleArea.parentNode) {
                                // 日付の下に挿入したいが、構造上難しいのでcontentAreaの直前に入れる
                                contentArea.parentNode.insertBefore(createNav(), contentArea);
                            }
                            
                            // 下部ナビゲーション
                            contentArea.appendChild(createNav());
                        }
                    }
                }
            } catch (e) { console.log("Nav error:", e); }

            if (window.MathJax) {
            // MathJax 3 でレンダリング (ロード待ち対応)
            const renderMath = () => {
                if (window.MathJax && window.MathJax.typesetPromise) {
                    MathJax.typesetPromise([contentArea]).catch((err) => console.log('MathJax error: ' + err));
                } else {
                    // まだロードされていない場合は少し待って再試行
                    setTimeout(renderMath, 100);
                }
            };
            renderMath();
            } // if (window.MathJax) の閉じ括弧を追加

            // Highlight.js
            if (window.hljs) {
                contentArea.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }

        } catch (error) {
            console.error('Failed to load article:', error);
            document.getElementById('article-content').innerHTML = `<div style="color:red;padding:20px;background:#fff;border:1px solid red;"><h3>読み込みエラー</h3><p>${error.message}</p></div>`;
        }
    }

    loadArticle();
</script>
<script>
    if (window.location.hostname === "localhost") {
        const evtSource = new EventSource("/_livereload/events");
        evtSource.onmessage = function(event) {
            if (event.data === "reload") location.reload();
        };
    }
</script>
</body>
</html>